<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Flow Studio ‚Äî Multi-Screen (Tabs) + JSON + Preview</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --green:#128c7e; --bg:#f7f7f7; --border:#ddd; --text:#222; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); height:100vh; display:flex; flex-direction:column; }
    /* Header tabs */
    .tabs { background:#fff; border-bottom:1px solid var(--border); padding:8px 12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tab { padding:8px 12px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; }
    .tab.active { background:var(--green); color:#fff; border-color:var(--green); }
    .tab .close { margin-left:8px; opacity:.8; }
    .btn { background:var(--green); color:#fff; border:0; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#eee; color:#333; border:1px solid #ddd; }
    .btn.danger { background:#e74c3c; }

    /* Top builder row */
    .top { display:grid; grid-template-columns: 400px 1fr; gap:12px; padding:12px; border-bottom:1px solid var(--border); background:#fff; }
    .card { border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px; }
    h3 { margin:6px 0 10px; font-size:15px; }
    label { display:block; font-size:12px; color:#555; margin:8px 0 4px; }
    input[type="text"], input[type="url"], input[type="number"], textarea, select {
      width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; background:#fff; font-size:14px;
    }
    textarea.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre; }
    .row { display:flex; gap:8px; }
    .row>* { flex:1; }

    /* Components list */
    .comp { border:1px solid var(--border); border-radius:10px; padding:8px; margin:8px 0; background:#fafafa; font-size:13px; }
    .comp .actions { display:flex; gap:6px; margin-top:6px; }
    .hint { color:#666; font-size:12px; }

    /* Bottom split */
    .bottom { flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:12px; }
    .panel { border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px; display:flex; flex-direction:column; }
    .panel-header { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .panel textarea { flex:1; resize:none; }
    /* Phone preview */
    .phone-wrap { display:flex; justify-content:center; align-items:flex-start; padding:8px; overflow:auto; }
    .phone { width:380px; background:#fff; border-radius:22px; box-shadow:0 8px 30px rgba(0,0,0,.15); border:1px solid #eee; padding:14px; }
    .screen-title { text-align:center; font-weight:800; font-size:15px; padding-bottom:8px; border-bottom:1px solid #eee; }
    .blk { margin:12px 0; }
    .heading { font-weight:800; font-size:16px; margin-bottom:6px; }
    .subheading { color:#777; font-size:13px; margin-bottom:6px; }
    .text { font-size:14px; }
    .input, .select, .textarea, .date, .file-btn {
      width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff;
    }
    .checkbox, .radio { display:flex; align-items:center; gap:8px; margin:6px 0; font-size:14px; }
    .footer { margin-top:10px; background:var(--green); color:#fff; border-radius:12px; padding:10px; text-align:center; font-weight:700; }
    .media { background:#eef6ff; border:1px solid #cfe5ff; border-radius:10px; padding:10px; }
    .small { font-size:12px; color:#666; }
    .warn { color:#b45309; font-weight:700; }
  </style>
</head>
<body>

  <!-- Tabs (screens) -->
  <div class="tabs" id="tabs"></div>

  <!-- Top builder -->
  <div class="top">
    <!-- Component creator -->
    <div class="card">
      <h3>Add Component to Active Screen</h3>
      <label>Type</label>
      <select id="type">
        <option>TextHeading</option>
        <option>TextSubheading</option>
        <option>TextBody</option>
        <option>TextCaption</option>
        <option>TextInput</option>
        <option>TextArea</option>
        <option>Dropdown</option>
        <option>RadioButtonsGroup</option>
        <option>CheckboxGroup</option>
        <option>OptIn</option>
        <option>DatePicker</option>
        <option>DocumentPicker</option>
        <option>PhotoPicker</option>
        <option>EmbeddedLink</option>
        <option>Footer</option>
      </select>
      <div id="propFields"></div>
      <button class="btn" id="addBtn">Add Component</button>
      <div class="small" id="mediaNote" style="margin-top:8px;"></div>
    </div>

    <!-- Components of active screen -->
    <div class="card">
      <h3>Components (<span id="count">0</span>)</h3>
      <div id="list"></div>
    </div>
  </div>

  <!-- Bottom: JSON | Preview -->
  <div class="bottom">
    <div class="panel">
      <div class="panel-header">
        <h3 style="margin:0;">Generated JSON</h3>
        <button class="btn" id="copyBtn">Copy</button>
        <button class="btn secondary" id="downloadBtn">Download</button>
      </div>
      <textarea id="jsonBox" class="mono" spellcheck="false"></textarea>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h3 style="margin:0;">Live Preview (Active Screen)</h3>
      </div>
      <div class="phone-wrap"><div class="phone" id="preview"></div></div>
    </div>
  </div>

<script>
/** STATE **/
let screens = [];
let active = 0;

const qs = s => document.querySelector(s);
const allowedMimes = [
  "application/gzip","application/msword","application/pdf","application/vnd.ms-excel",
  "application/vnd.ms-powerpoint","application/vnd.oasis.opendocument.presentation",
  "application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.text",
  "application/vnd.openxmlformats-officedocument.presentationml.presentation",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
  "application/x-7z-compressed","application/zip","image/avif","image/gif","image/heic",
  "image/heif","image/jpeg","image/png","image/tiff","image/webp","text/plain","video/mp4","video/mpeg"
];

/** words for screen ids (letters/underscores only) **/
const numWords = [
  'one','two','three','four','five','six','seven','eight','nine','ten',
  'eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen','twenty'
];

function screenIdFromIndex(i) {
  const word = numWords[i] || `s${i+1}`; // fallback letters if out of range
  return `screen_${word}`;               // only letters + underscore
}

function newScreen(i) {
  return {
    id: screenIdFromIndex(i),
    title: `Screen ${i+1}`,
    components: []
  };
}

/** INIT DEFAULT TWO SCREENS **/
screens = [newScreen(0), newScreen(1)];
active = 0;

/** TABS **/
function renderTabs() {
  const el = qs('#tabs');
  el.innerHTML = '';
  screens.forEach((s, i) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (i===active ? ' active' : '');
    tab.innerHTML = `${s.title}<span class="close" title="Remove" onclick="event.stopPropagation();removeScreen(${i})">‚úï</span>`;
    tab.onclick = () => { active = i; renderAll(); };
    el.appendChild(tab);
  });
  const addBtn = document.createElement('button');
  addBtn.className = 'btn';
  addBtn.textContent = '+ Add Screen';
  addBtn.onclick = () => {
    screens.push(newScreen(screens.length));
    active = screens.length - 1;
    renderAll();
  };
  el.appendChild(addBtn);
}
window.removeScreen = function(i) {
  if (screens.length === 1) return alert('Need at least one screen');
  screens.splice(i,1);
  if (active >= screens.length) active = screens.length - 1;
  renderAll();
}

/** BUILDER FIELDS **/
const typeSel = qs('#type');
const propFields = qs('#propFields');

function renderPropFields() {
  const t = typeSel.value;
  const parts = [];
  // components that support required
  const requiredAllowed = ['TextInput','TextArea','Dropdown','RadioButtonsGroup','CheckboxGroup','OptIn','DatePicker'];
  const labelName = ['TextInput','TextArea','Dropdown','RadioButtonsGroup','CheckboxGroup','OptIn','DatePicker','DocumentPicker','PhotoPicker'];

  // Textual
  if (['TextHeading','TextSubheading','TextBody','TextCaption'].includes(t)) {
    parts.push(`<label>Text</label><input id="prop_text">`);
  }

  // Common form fields (label & name)
  if (labelName.includes(t)) {
    if (!['Footer','EmbeddedLink'].includes(t)) {
      parts.push(`<label>Label</label><input id="prop_label">`);
      parts.push(`<label>Name</label><input id="prop_name" placeholder="field_name">`);
    }
    if (requiredAllowed.includes(t)) {
      parts.push(`<label>Required</label><select id="prop_required"><option value="">(default)</option><option>true</option><option>false</option></select>`);
    }
  }

  // Options lists
  if (['Dropdown','RadioButtonsGroup','CheckboxGroup'].includes(t)) {
    parts.push(`
      <label>Options (JSON)</label>
      <textarea id="prop_options" class="mono" rows="6">[
  { "id":"opt1", "title":"Option 1" },
  { "id":"opt2", "title":"Option 2" }
]</textarea>`);
  }

  // TextInput
  if (t === 'TextInput') {
    parts.push(`<label>Input Type</label><input id="prop_input_type" placeholder="text (default)">`);
  }

  // EmbeddedLink
  if (t === 'EmbeddedLink') {
    parts.push(`<label>Text</label><input id="prop_text" value="Open link">`);
    parts.push(`<label>URL</label><input id="prop_url" placeholder="https://example.com" value="https://developers.facebook.com">`);
  }

  // Footer
  if (t === 'Footer') {
    parts.push(`<label>Button Label</label><input id="prop_label" value="Submit">`);
    parts.push(`<label>Payload (JSON)</label><textarea id="prop_footer_payload" class="mono" rows="4">{}</textarea>`);
  }

  // DocumentPicker (no required)
  if (t === 'DocumentPicker') {
    parts.push(`
      <label>Description</label><input id="prop_desc" placeholder="Attach files">
      <div class="row">
        <div><label>Min Docs</label><input id="prop_min" type="number" value="1"></div>
        <div><label>Max Docs</label><input id="prop_max" type="number" value="5"></div>
      </div>
      <label>Max File Size (KB)</label><input id="prop_maxkb" type="number" value="5120">
      <label>Allowed MIME Types (multi)</label>
      <select id="prop_mimes" multiple style="height:140px;">${
        allowedMimes.map(m=>`<option value="${m}">${m}</option>`).join('')
      }</select>
    `);
  }

  // PhotoPicker (no required)
  if (t === 'PhotoPicker') {
    parts.push(`
      <label>Description</label><input id="prop_desc" placeholder="Attach photos">
      <label>Photo Source</label>
      <select id="prop_source">
        <option value="camera_gallery">Camera + Gallery</option>
        <option value="camera">Camera Only</option>
        <option value="gallery">Gallery Only</option>
      </select>
      <div class="row">
        <div><label>Min Photos</label><input id="prop_min" type="number" value="1"></div>
        <div><label>Max Photos</label><input id="prop_max" type="number" value="10"></div>
      </div>
      <label>Max File Size (KB)</label><input id="prop_maxkb" type="number" value="10240">
    `);
  }

  propFields.innerHTML = parts.join('');
  updateMediaNote();
}
typeSel.addEventListener('change', renderPropFields);

/** MEDIA RULE NOTE **/
function updateMediaNote() {
  const scr = screens[active];
  const hasMedia = scr.components.some(c => c.type === 'DocumentPicker' || c.type === 'PhotoPicker');
  const picking = typeSel.value === 'DocumentPicker' || typeSel.value === 'PhotoPicker';
  const note = qs('#mediaNote');
  if (hasMedia) {
    note.innerHTML = `‚ö†Ô∏è This screen already has a media picker. WhatsApp allows <span class="warn">only one</span> media picker per screen.`;
  } else if (picking) {
    note.textContent = '‚úÖ You can add one media picker to this screen.';
  } else {
    note.textContent = '';
  }
}

/** ADD / REMOVE / MOVE COMPONENTS **/
qs('#addBtn').addEventListener('click', () => {
  const t = typeSel.value;
  const scr = screens[active];

  // Enforce one media picker per screen
  if ((t === 'DocumentPicker' || t === 'PhotoPicker') &&
      scr.components.some(c => c.type === 'DocumentPicker' || c.type === 'PhotoPicker')) {
    return alert('Only one media picker allowed per screen.');
  }

  const v = id => (qs('#'+id) ? qs('#'+id).value.trim() : '');
  const item = { type: t };

  // Text types
  if (['TextHeading','TextSubheading','TextBody','TextCaption'].includes(t)) {
    if (qs('#prop_text')) item.text = v('prop_text');
  }

  // Common (only set required for allowed types)
  const requiredAllowed = ['TextInput','TextArea','Dropdown','RadioButtonsGroup','CheckboxGroup','OptIn','DatePicker'];
  if (['TextInput','TextArea','Dropdown','RadioButtonsGroup','CheckboxGroup','OptIn','DatePicker','DocumentPicker','PhotoPicker'].includes(t)) {
    if (!['Footer','EmbeddedLink'].includes(t)) {
      if (qs('#prop_label')) item.label = v('prop_label');
      if (qs('#prop_name')) item.name  = v('prop_name');
    }
    if (requiredAllowed.includes(t)) {
      const req = v('prop_required');
      if (req === 'true')  item.required = true;
      if (req === 'false') item.required = false;
    }
  }

  if (t === 'TextInput') {
    const it = v('prop_input_type');
    if (it) item['input-type'] = it;
  }

  if (['Dropdown','RadioButtonsGroup','CheckboxGroup'].includes(t)) {
    try {
      item['data-source'] = JSON.parse(v('prop_options') || '[]');
    } catch {
      return alert('Options must be valid JSON');
    }
  }

  if (t === 'EmbeddedLink') {
    item.text = v('prop_text') || 'Open link';
    item['on-click-action'] = { name:'open_url', url: v('prop_url') || 'https://example.com' };
  }

  if (t === 'Footer') {
    let payload = {};
    try { payload = JSON.parse(v('prop_footer_payload') || '{}'); } catch { return alert('Footer payload must be valid JSON'); }
    item['on-click-action'] = { name:'complete', payload };
  }

  if (t === 'DocumentPicker') {
    item.description = v('prop_desc');
    item['min-uploaded-documents'] = Number(v('prop_min') || 0);
    item['max-uploaded-documents'] = Number(v('prop_max') || 1);
    item['max-file-size-kb'] = Number(v('prop_maxkb') || 5120);
    const sel = qs('#prop_mimes');
    item['allowed-mime-types'] = sel ? [...sel.selectedOptions].map(o=>o.value) : [];
  }

  if (t === 'PhotoPicker') {
    item.description = v('prop_desc');
    item['photo-source'] = v('prop_source') || 'camera_gallery';
    item['min-uploaded-photos'] = Number(v('prop_min') || 0);
    item['max-uploaded-photos'] = Number(v('prop_max') || 1);
    item['max-file-size-kb'] = Number(v('prop_maxkb') || 10240);
  }

  scr.components.push(item);
  renderComps();
  renderJSON();
  renderPreview();
  updateMediaNote();
});

function renderComps() {
  const scr = screens[active];
  qs('#count').textContent = scr.components.length;
  const list = qs('#list');
  list.innerHTML = scr.components.map((c,i)=>`
    <div class="comp">
      <div><b>${i+1}. ${c.type}</b></div>
      <div class="hint">${escapeHtml(JSON.stringify(c))}</div>
      <div class="actions">
        <button class="btn secondary" onclick="moveComp(${i},-1)">‚¨ÜÔ∏è</button>
        <button class="btn secondary" onclick="moveComp(${i},1)">‚¨áÔ∏è</button>
        <button class="btn danger" onclick="delComp(${i})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}
window.moveComp = function(i,dir){
  const scr = screens[active];
  const j = i + dir;
  if (j < 0 || j >= scr.components.length) return;
  const [it] = scr.components.splice(i,1);
  scr.components.splice(j,0,it);
  renderComps(); renderJSON(); renderPreview();
};
window.delComp = function(i){
  const scr = screens[active];
  scr.components.splice(i,1);
  renderComps(); renderJSON(); renderPreview(); updateMediaNote();
};

/** JSON GEN (all screens) **/
function buildFlow() {
  return {
    version: "7.2",
    data_api_version: "3.0",
    routing_model: Object.fromEntries(screens.map(s => [s.id, []])), // keys like screen_one
    screens: screens.map(s => ({
      id: s.id, // id like screen_one
      title: s.title,
      terminal: true,
      layout: {
        type: "SingleColumnLayout",
        children: [
          { type:"Form", name:"form_main", children: s.components }
        ]
      }
    }))
  };
}
function renderJSON(){
  qs('#jsonBox').value = JSON.stringify(buildFlow(), null, 2);
}
qs('#copyBtn').addEventListener('click', ()=>{
  navigator.clipboard.writeText(qs('#jsonBox').value);
  alert('JSON copied');
});
qs('#downloadBtn').addEventListener('click', ()=>{
  const blob = new Blob([qs('#jsonBox').value],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'flow.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

/** PREVIEW (active screen) **/
function renderPreview(){
  const prev = qs('#preview');
  const s = screens[active];
  let html = `<div class="screen-title">${escapeHtml(s.title)}</div>`;
  s.components.forEach(c=>{
    switch(c.type){
      case 'TextHeading':
        html += `<div class="blk"><div class="heading">${escapeHtml(c.text||'')}</div></div>`; break;
      case 'TextSubheading':
        html += `<div class="blk"><div class="subheading">${escapeHtml(c.text||'')}</div></div>`; break;
      case 'TextBody':
      case 'TextCaption':
        html += `<div class="blk"><div class="text">${escapeHtml(c.text||'')}</div></div>`; break;
      case 'TextInput':
        html += `<div class="blk"><div class="small">${escapeHtml(c.label||'')}</div><input class="input" placeholder="${escapeHtml(c.label||'')}"></div>`; break;
      case 'TextArea':
        html += `<div class="blk"><div class="small">${escapeHtml(c.label||'')}</div><textarea class="textarea" rows="3" placeholder="${escapeHtml(c.label||'')}"></textarea></div>`; break;
      case 'Dropdown':
        html += `<div class="blk"><div class="small">${escapeHtml(c.label||'')}</div><select class="select">${
          (c['data-source']||[]).map(o=>`<option value="${escapeHtml(o.id)}">${escapeHtml(o.title)}</option>`).join('')
        }</select></div>`; break;
      case 'RadioButtonsGroup':
        html += `<div class="blk"><div class="small">${escapeHtml(c.label||'')}</div>${
          (c['data-source']||[]).map(o=>`<label class="radio"><input type="radio" name="${escapeHtml(c.name||'r')}"> ${escapeHtml(o.title)}</label>`).join('')
        }</div>`; break;
      case 'CheckboxGroup':
        html += `<div class="blk"><div class="small">${escapeHtml(c.label||'')}</div>${
          (c['data-source']||[]).map(o=>`<label class="checkbox"><input type="checkbox"> ${escapeHtml(o.title)}</label>`).join('')
        }</div>`; break;
      case 'OptIn':
        html += `<div class="blk"><label class="checkbox"><input type="checkbox"> ${escapeHtml(c.label||'I agree')}</label></div>`; break;
      case 'DatePicker':
        html += `<div class="blk"><div class="small">${escapeHtml(c.label||'Choose a date')}</div><input type="date" class="date"></div>`; break;
      case 'DocumentPicker':
        html += `<div class="blk"><div class="media">
          <b>üìÑ ${escapeHtml(c.label||'Upload Document')}</b><br>
          ${c.description ? `<div class="small">${escapeHtml(c.description)}</div>`:''}
          <div class="small">Min: ${c['min-uploaded-documents']??0} | Max: ${c['max-uploaded-documents']??1}</div>
          <div class="small">Max Size: ${((c['max-file-size-kb']??5120)/1024).toFixed(1)} MB</div>
          <div class="small">MIME: ${(c['allowed-mime-types']||[]).join(', ') || '‚Äî'}</div>
        </div></div>`; break;
      case 'PhotoPicker':
        html += `<div class="blk"><div class="media">
          <b>üì∏ ${escapeHtml(c.label||'Upload Photos')}</b><br>
          ${c.description ? `<div class="small">${escapeHtml(c.description)}</div>`:''}
          <div class="small">Source: ${escapeHtml(c['photo-source']||'camera_gallery')}</div>
          <div class="small">Min: ${c['min-uploaded-photos']??0} | Max: ${c['max-uploaded-photos']??1}</div>
          <div class="small">Max Size: ${((c['max-file-size-kb']??10240)/1024).toFixed(1)} MB</div>
        </div></div>`; break;
      case 'EmbeddedLink':
        html += `<div class="blk"><a href="${encodeURI(c['on-click-action']?.url||'#')}" target="_blank">üîó ${escapeHtml(c.text||'Open link')}</a></div>`; break;
      case 'Footer':
        html += `<div class="blk"><div class="footer">${escapeHtml(c.label||'Submit')}</div></div>`; break;
      default:
        html += `<div class="blk"><div class="text">Unsupported: ${escapeHtml(c.type)}</div></div>`;
    }
  });
  qs('#preview').innerHTML = html;
}

/** UTILS **/
function escapeHtml(s=''){
  return String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

/** RENDER ALL **/
function renderAll(){ renderTabs(); renderPropFields(); renderComps(); renderJSON(); renderPreview(); }
renderAll();
</script>
</body>
</html>
